[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Fe Treatment Model",
    "section": "",
    "text": "Reactions affect solute and solid model species differently.\nThe solid model species are the same occurring in the chemical reaction equations. Therefore they are affected directly according to the reaction stoichiometry.\nSolute model species are either component-totals (e.g. DIC, TOT_P, …) to be speciated later or species on their own (e.g. O2, CH4). The effect of reactions on solute species is first formulated for the species occurring in the chemical reaction equations according to the reaction stoichiometry. In a second step this changes are translated to changes of the component-totals / model species using a translation table.\n\n\n\nFor solutes the (probably) dominant species of a component-total governs the diffusion coefficient (cf code-block “Diffusion Coefficients”). The transport of solids is not affected by species properties."
  },
  {
    "objectID": "index.html#concept",
    "href": "index.html#concept",
    "title": "Fe Treatment Model",
    "section": "",
    "text": "Reactions affect solute and solid model species differently.\nThe solid model species are the same occurring in the chemical reaction equations. Therefore they are affected directly according to the reaction stoichiometry.\nSolute model species are either component-totals (e.g. DIC, TOT_P, …) to be speciated later or species on their own (e.g. O2, CH4). The effect of reactions on solute species is first formulated for the species occurring in the chemical reaction equations according to the reaction stoichiometry. In a second step this changes are translated to changes of the component-totals / model species using a translation table.\n\n\n\nFor solutes the (probably) dominant species of a component-total governs the diffusion coefficient (cf code-block “Diffusion Coefficients”). The transport of solids is not affected by species properties."
  },
  {
    "objectID": "index.html#reactions-describing-om-decomposition",
    "href": "index.html#reactions-describing-om-decomposition",
    "title": "Fe Treatment Model",
    "section": "Reactions Describing OM Decomposition",
    "text": "Reactions Describing OM Decomposition\n\nOM Composition\n\\(\\ce{(CH2O)_a (NH3)_b (H3PO4)_c}\\)\n\n\\(a = 1\\)\n\\(b = 16/106\\)\n\\(c = 1/106\\)\n\n\n\nRate Constants\n\n\\(k_{\\alpha} = 0.05 - 1.62 \\: yr^{-1}\\) (Moodley et al. 2005; Tromp, Van Cappellen, and Key 1995)\n\\(k_{\\beta} = 0.025 - 0.0086 \\: yr^{-1}\\) (Tromp, Van Cappellen, and Key 1995)\n\n\n\nLimitation (L) and Inihibition (I) Terms\n\nO2\n\\(L_{\\ce{O2}} = \\frac{[\\ce{O2}]}{K_{\\ce{O2}} + [\\ce{O2}]}\\)\n\\(I_{\\ce{O2}} = \\frac{K_{\\ce{O2}}}{K_{\\ce{O2}} + [\\ce{O2}]}\\)\nwith \\(K_{O2} = 0.001 - 0.03 \\: mol \\: m^{-3}_{pw}\\) (Wang and Van Cappellen 1996)\n\n\nNO3-\n\\(L_{\\ce{NO3^-}} = \\frac{[\\ce{NO3^-}]}{K_{\\ce{NO3-}} + [\\ce{NO3^-}]}\\)\n\\(I_{\\ce{NO3^-}} = \\frac{K_{\\ce{NO3^-}}}{K_{\\ce{NO3^-}} + [\\ce{NO3^-}]}\\)\nwith \\(K_{NO3-} = 0.004 - 0.08 \\: mol \\: m^{-3}_{pw}\\) (Wang and Van Cappellen 1996)\n\n\nMnO2\n\\(L_{\\ce{MnO2^{\\alpha}}} = \\frac{[\\ce{MnO2^{\\alpha}}]}{K_{\\ce{MnO2}} + [\\ce{MnO2^{\\alpha}}]}\\)\n\\(I_{\\ce{MnO2^{\\alpha}}} = \\frac{K_{\\ce{MnO2}}}{K_{\\ce{MnO2}} + [\\ce{MnO2^{\\alpha}}]}\\)\nwith \\(K_{\\ce{MnO2^{\\alpha}}} = \\{0.004 - 0.032\\} \\: mol \\: {kg}^{-1} \\cdot \\rho_{dry}\\) (Wang and Van Cappellen 1996)\n\n\nFe(OH)3\n\\(L_{\\ce{Fe(OH)3_{; tot}^\\alpha}} = \\frac{[\\ce{Fe(OH)3_{; tot}^\\alpha}]}{K_{\\ce{Fe(OH)3}} + [\\ce{Fe(OH)3_{; tot}^\\alpha}]}\\)\n\\(I_{\\ce{Fe(OH)3^\\alpha}} = \\frac{K_{\\ce{Fe(OH)3}}}{K_{\\ce{Fe(OH)3}} + [\\ce{Fe(OH)3_{; tot}^\\alpha}]}\\)\nwith \\(K_{\\ce{FeOH3}} = \\{0.065 - 0.1\\} \\: mol \\: {kg}^{-1} \\cdot \\rho_{dry}\\) (Wang and Van Cappellen 1996)\n\n\nSO42-\n\\(L_{\\ce{SO4^{2-}}} = \\frac{[\\ce{SO4^{2-}}]}{K_{\\ce{SO4^{2-}}} + [\\ce{SO4^{2-}}]}\\)\n\\(I_{\\ce{SO4^{2-}}} = \\frac{K_{\\ce{SO4^{2-}}}}{K_{\\ce{SO4^{2-}}} + [\\ce{SO4^{2-}}]}\\)\nwith \\(K_{SO42-} = 0.0016 \\: mol \\: {m^{-3}_{pw}}\\) (Wang and Van Cappellen 1996)\n\n\nH3PO4\n\\(L_{\\ce{H3PO4}} = \\frac{[\\ce{H3PO4}]}{K_{\\ce{H3PO4}} + [\\ce{H3PO4}]}\\)\nwith \\(K_{\\ce{H3PO4}} = 10^{-5} \\: mol \\: m^{-3}_{pw}\\) (Reinier)\n\nformulated for lump sum\n\n\n\n\nFeOH3 Fractions\n\\(\\ce{Fe(OH)3_{; tot}^\\alpha} = \\ce{Fe(OH)3^{\\alpha}} + \\ce{Fe(OH)3^\\alpha(H3PO4)_{\\lambda}}\\) with \\(\\lambda = 0.6\\)\n\\(\\chi = \\frac{[\\ce{Fe(OH)3^{\\alpha}}]}{[\\ce{Fe(OH)3_{; tot}^\\alpha}]}\\)\n\n\nReactions\n\nOM + O2 (R1)\n\\(\\ce{OM^{\\alpha, \\beta} + O2 -&gt; CO2 + b NH3 + c H3PO4 + H2O}\\)\n\\(R = k_{\\alpha, \\beta} \\: OM^{\\alpha, \\beta} \\: L_{\\ce{O2}}\\)\n\n\nOM + HNO3 (R2)\n\\(\\ce{OM^{\\alpha, \\beta} + 4/5 HNO3 -&gt; CO2 + b NH3 + c H3PO4 + 2/5 N2 + 7/5 H2O}\\)\n\\(R = k_{\\alpha, \\beta} \\: OM^{\\alpha, \\beta} \\: L_{\\ce{NO3-}} \\: I_{\\ce{O2}}\\)\n\n\nOM + MnO2 (R3)\n\\(\\ce{OM^{\\alpha, \\beta} + 2 MnO2 + H2O -&gt; CO2 + b NH3 + c H3PO4 + 2 Mn(OH)2}\\)\n\\(R = k_{\\alpha, \\beta} \\: OM^{\\alpha, \\beta} \\: L_{\\ce{MnO2}^\\alpha} \\: I_{\\ce{NO3^-}} \\: I_{\\ce{O2}}\\)\n\n\nOM + FeOH3 / FeOH3~H3PO4 (R4)\n\\(\\ce{OM^{\\alpha, \\beta} + 4 (\\chi Fe(OH)3^{\\alpha} + (1 - \\chi) Fe(OH)3^\\alpha(H3PO4)_{\\lambda} ) -&gt; CO2 + b NH3 + (c + (1- \\chi) 4 \\lambda) H3PO4 + 4 Fe(OH)2 + 3 H2O}\\)\n\\(R = k_{\\alpha, \\beta} \\: OM^{\\alpha, \\beta} \\: L_{\\ce{Fe(OH)3_{; tot}^\\alpha}} \\: I_{\\ce{MnO2^{\\alpha}}} \\: I_{\\ce{NO3^-}} \\: I_{\\ce{O2}}\\)\n\n\nOM + H2SO4 (R5)\n\\(\\ce{OM^{\\alpha, \\beta} + 1/2 H2SO4 -&gt; CO2 + b NH3 + c H3PO4 + 1/2 H2S + H2O}\\)\n\\(R = k_{\\alpha, \\beta} \\: OM^{\\alpha, \\beta} \\: L_{\\ce{SO4^{2-}}} \\: I_{\\ce{Fe(OH)3^\\alpha}} \\: I_{\\ce{MnO2^{\\alpha}}} \\: I_{\\ce{NO3^-}} \\: I_{\\ce{O2}}\\)\n\n\nMethanogenesis (R6)\n\\(\\ce{OM^{\\alpha, \\beta} -&gt; 1/2 CO2 + b NH3 + c H3PO4 + 1/2 CH4}\\)\n\\(R = k_{\\alpha, \\beta} \\: OM^{\\alpha, \\beta} \\: I_{\\ce{SO4^{2-}}} \\: I_{\\ce{Fe(OH)3^\\alpha}} \\: I_{\\ce{MnO2^{\\alpha}}} \\: I_{\\ce{NO3^-}} \\: I_{\\ce{O2}}\\)"
  },
  {
    "objectID": "index.html#secondary-redox-reactions",
    "href": "index.html#secondary-redox-reactions",
    "title": "Fe Treatment Model",
    "section": "Secondary Redox Reactions",
    "text": "Secondary Redox Reactions\n\nH2S Oxidation (R11)\n\\(\\ce{2 O2 + H2S -&gt; H2SO4}\\)\n\\(R = k \\: [\\ce{O2}] \\: [\\ce{\\sum H2S}]\\)\nwith \\(k \\geq 1.6 \\times 10^2 \\: m^3 \\: mol^{-1} \\: yr^{-1}\\) (Wang and Van Cappellen 1996)\n\n\nSO4-Reduction coupled to AOM (R12)\n\\(\\ce{H2SO4 + CH4 -&gt; CO2 + H2S + 2 H2O}\\)\n\\(R = k \\: [\\ce{SO4^{2-}}] \\: [\\ce{CH4}]\\)\nwith \\(k = 10 - 120 \\: m^3 \\: mol^{-1} \\: yr^{-1}\\) (Wang and Van Cappellen 1996; Rooze et al. 2016)"
  },
  {
    "objectID": "index.html#redox-precipitation-dissolution-reactions",
    "href": "index.html#redox-precipitation-dissolution-reactions",
    "title": "Fe Treatment Model",
    "section": "Redox Precipitation / Dissolution Reactions",
    "text": "Redox Precipitation / Dissolution Reactions\n\nFeOH3 / FeOH3~H3PO4-Reduction coupled to Sulphide Oxidation (R9)\n\\(\\ce{2 ( \\chi Fe(OH)3^{\\alpha} + (1-\\chi) Fe(OH)3^{\\alpha}(H3PO4)_{\\lambda} ) + H2S -&gt; 2 Fe(OH)_2 + S^0 + 2 H2O + 2 (1 - \\chi) \\lambda H3PO4}\\)\n\\(R = k \\: [\\ce{Fe(OH)3_{; tot}^{\\alpha}}] \\: [\\ce{\\sum H2S}] \\quad (mol \\: {m_{sf}}^{-3} \\: yr^{-3})\\)\nwith \\(k \\leq 10^2 \\: {m_{pw}}^3 \\: mol^{-1} \\: yr^{-1}\\) (Wang and Van Cappellen 1996)\n\nunit correct???\n\n\n\nFeOH3 / FeOH3~H3PO4-Formation (R10)\n\\(\\ce{O2 + 4 Fe(OH)_2 + 2 H2O + 4 L_{\\ce{H3PO4}} \\lambda H3PO4 -&gt; 4 ( (1 - L_{\\ce{H3PO4}}) Fe(OH)3^{\\alpha} + L_{\\ce{H3PO4}} Fe(OH)3^{\\alpha}(H3PO3)_{\\lambda} )}\\)\n\\(R = k \\: [\\ce{O2}] \\: [\\ce{Fe^{2+}}]\\)\nwith \\(k = 1.4 \\times 10^5 \\: {m_{pw}}^3 \\: mol^{-1} \\: yr^{-1}\\) (Wang and Van Cappellen 1996)"
  },
  {
    "objectID": "index.html#precipitation-reactions",
    "href": "index.html#precipitation-reactions",
    "title": "Fe Treatment Model",
    "section": "Precipitation Reactions",
    "text": "Precipitation Reactions\n\nSiderite Precipitation (R7) / Dissolution (R8)\nIn general:\n\\(\\ce{FeCO3 &lt;-&gt; Fe^{2+} + CO3^{2-}}\\)\nIn our model:\n\\(\\ce{FeCO3 + 2 H2O &lt;-&gt; Fe(OH)2 + H2CO3}\\)\nPrecipitation and Dissolution are split in two reactions from which only one is active at a time, depending on the saturation state \\(\\Omega\\).\n\\(\\Omega = \\frac{\\ce{[Fe^{2+}]} \\cdot \\ce{[CO3^{2-}]}}{K_{sp; siderite}} \\quad\\) with \\(\\quad K_{sp; siderite} = 10^{-10.4} \\cdot 1000^2 \\; mol^2 \\; m^{-6}\\)\nIf \\(\\: \\Omega &gt; 1\\):\n\n\\(R_{precipitation} = k_{precip} \\cdot (\\Omega - 1)^2 \\quad\\) with \\(\\quad k_{precip} \\approx 1.8 \\times 10^{2} \\; mol \\; {m_{sf}}^{-3} \\; yr^{-1}\\)\n\\(R_{dissolution} = 0\\)\n\nIf \\(\\: \\Omega &lt; 1\\):\n\n\\(R_{precipitation} = 0\\)\n\\(R_{dissolution} = - k_{diss} \\cdot \\ce{[FeCO3]} \\cdot (\\Omega - 1)^2 \\quad\\) with \\(\\quad k_{diss} \\approx 2.5 \\times 10^{-1} \\; yr^{-1}\\)\n\n\n\nFeS Precipitation (R13) / Dissolution (R14)\nChemically:\n\\(\\ce{Fe^{2+} + HS- &lt;-&gt; FeS + H+}\\)\nIn our model:\n\\(\\ce{Fe(OH)_2 + H2S &lt;-&gt; FeS + 2 H2O}\\)\nPrecipitation and Dissolution are split in two reactions from which only one is active at a time, depending on the saturation state \\(\\Omega\\).\n\\(\\Omega = \\frac{\\ce{[Fe^{2+}]} \\cdot \\ce{[HS^{-}]}}{K_{sp; FeS}} \\quad\\) with \\(\\quad K_{sp; FeS} = 10^{-3.915} \\cdot 1000^2 \\; mol^2 \\; m^{-6}\\)\n\nphreeqc.dat\nFeS(ppt) | FeS + H+ = Fe+2 + HS- | log_k -3.915\n\nIf \\(\\: \\Omega &gt; 1\\):\n\n\\(R_{precipitation} = k_{precip} \\cdot (\\Omega - 1)^2 \\quad\\) with \\(\\quad k_{precip} \\approx 2.5 \\times 10^{-3} \\; mol \\; {m_{sf}}^{-3} \\; yr^{-1}\\) (Markelov et al. 2019)\n\\(R_{dissolution} = 0\\)\n\nIf \\(\\: \\Omega &lt; 1\\):\n\n\\(R_{precipitation} = 0\\)\n\\(R_{dissolution} = - k_{diss} \\cdot \\ce{[FeS]} \\cdot (\\Omega - 1)^2 \\quad\\) with \\(\\quad k_{diss} \\approx 1 \\times 10^{-3} \\; yr^{-1}\\) (Markelov et al. 2019)"
  },
  {
    "objectID": "index.html#equilibrium-reactions-described-via-tableau",
    "href": "index.html#equilibrium-reactions-described-via-tableau",
    "title": "Fe Treatment Model",
    "section": "Equilibrium Reactions described via Tableau",
    "text": "Equilibrium Reactions described via Tableau\nThe Tableau is used to calculate equilibrium speciation of solute species after model run. Fast equilibrium reactions are neglected during model runtime (so far).\n\n\n\n\n\nSpecies\nH2O\nH\nH2CO3\nH2PO4\nNO3\nNH4\nSO4\nH2S\nlogK\n\n\n\n\nH2O\n1\n\n\n\n\n\n\n\n0.00\n\n\nH\n\n1\n\n\n\n\n\n\n0.00\n\n\nOH\n1\n-1\n\n\n\n\n\n\n-8.00\n\n\nH2CO3\n\n\n1\n\n\n\n\n\n0.00\n\n\nHCO3\n\n-1\n1\n\n\n\n\n\n-3.35\n\n\nCO3\n\n-2\n1\n\n\n\n\n\n-10.68\n\n\nH3PO4\n\n1\n\n1\n\n\n\n\n-0.84\n\n\nH2PO4\n\n\n\n1\n\n\n\n\n0.00\n\n\nHPO4\n\n-1\n\n1\n\n\n\n\n-4.21\n\n\nPO4\n\n-2\n\n1\n\n\n\n\n-13.53\n\n\nHNO3\n\n1\n\n\n1\n\n\n\n-4.37\n\n\nNO3\n\n\n\n\n1\n\n\n\n0.00\n\n\nNH4\n\n\n\n\n\n1\n\n\n0.00\n\n\nNH3\n\n-1\n\n\n\n1\n\n\n-6.25\n\n\nH2SO4\n\n2\n\n\n\n\n1\n\n-7.10\n\n\nHSO4\n\n1\n\n\n\n\n1\n\n-1.10\n\n\nSO4\n\n\n\n\n\n\n1\n\n0.00\n\n\nH2S\n\n\n\n\n\n\n\n1\n0.00\n\n\nHS\n\n-1\n\n\n\n\n\n1\n-4.00\n\n\nS2\n\n-2\n\n\n\n\n\n1\n-15.00"
  },
  {
    "objectID": "index.html#functions",
    "href": "index.html#functions",
    "title": "Fe Treatment Model",
    "section": "Functions",
    "text": "Functions\n\nSolve Tableau\n\n\nCode\nsolve_tableau &lt;- function(component_total, tableau, logK, N_grid) {\n  \n  # load shared object\n  dyn.load(\"solve_tableau.so\")\n\n  return(.Fortran(\"solve_tableau\",\n                  component_total = as.double(component_total),\n                  tableau         = matrix(as.double(tableau), ncol = ncol(tableau)),\n                  logK            = as.double(logK),\n                  N_components    = as.integer(ncol(tableau)),\n                  N_species       = as.integer(nrow(tableau)),\n                  N_grid          = as.integer(N_grid),\n                  iter_pcfm       = rep(as.integer(0), N_grid),\n                  iter_newton     = rep(as.integer(0), N_grid),\n                  info_newton     = rep(as.integer(0), N_grid),\n                  difference      = matrix(as.double(0), ncol = ncol(tableau), nrow = N_grid),\n                  species_conc    = matrix(as.double(0), ncol = nrow(tableau), nrow = N_grid),\n                  success         = rep(as.integer(0), N_grid)\n                  )\n  )\n  \n}\n\n\n\n\nCalculate Speciation-Ratios for Fixed pH\n\n\nCode\nspeciation_ratios &lt;- function(pH, tableau, tableau_species, logK) {\n\n  # determine number of total components TOT_X in tableau\n  N_components &lt;- ncol(tableau)\n\n  # prepare vector with \"component-concentrations\"\n  # here we are only interested in ratios at a fixed pH ...\n  # so the only one that matters is the first one: TOT_H; the rest is set to 1\n  component_conc &lt;- c(log10(10^-pH * 10^3), rep(1, N_components - 1))\n\n  # calculate species concentrations\n  species_conc &lt;- as.list(10**(tableau %*% component_conc + logK))\n\n  # name entries\n  names(species_conc) &lt;- tableau_species\n\n  # calculate ratios of interest\n  with(species_conc, {\n    ratios &lt;- c(\n      fixed_H = 10^-pH * 10^3,\n      f_H2CO3 = H2CO3 / sum(H2CO3, HCO3, CO3),\n      f_HCO3  =  HCO3 / sum(H2CO3, HCO3, CO3),\n      f_CO3   =   CO3 / sum(H2CO3, HCO3, CO3),\n      f_H2S   =   H2S / sum(H2S, HS, S2),\n      f_HS    =    HS / sum(H2S, HS, S2),\n      f_S2    =    S2 / sum(H2S, HS, S2),\n      f_H3PO4 = H3PO4 / sum(H3PO4, H2PO4, HPO4, PO4),\n      f_H2PO4 = H2PO4 / sum(H3PO4, H2PO4, HPO4, PO4),\n      f_HPO4  = HPO4  / sum(H3PO4, H2PO4, HPO4, PO4),\n      f_PO4   = PO4   / sum(H3PO4, H2PO4, HPO4, PO4),\n      f_NH4   = NH4   / sum(NH4, NH3),\n      f_NH3   = NH3   / sum(NH4, NH3)\n    )\n\n    return(ratios)\n  })\n}\n\n\n\n\nPlot steady.1D Results\n\n\nCode\nplot_simple_comparision &lt;- function(a, b, a_name, b_name, grid, xlab, ylab, log = \"\") {\n  plot(\n    grid$x.mid ~ a,\n    ylim = c(max(grid$x.int), min(grid$x.int)),\n    xlim = c(min(a, b), max(a, b)),\n    type = \"l\",\n    ylab = ylab,\n    xlab = xlab,\n    lwd = 2,\n    col = \"gray45\",\n    lty = 2,\n    log = log\n  )\n  points(\n    grid$x.mid ~ b,\n    type = \"l\",\n    lwd = 2,\n    col = \"black\"\n  )\n  legend(\n    \"bottomright\",\n    legend = c(a_name, b_name),\n    col = c(\"gray45\", \"black\"),\n    lwd = 2,\n    lty = c(2, 1),\n    box.lwd = 0\n  )\n}\n\nplot_std_profiles &lt;- function(std_gray, std_black, grid) {\n\n  std_black &lt;- cbind(grid = grid$x.mid, std_black$y)\n  \n  plot(std_gray, xyswap = TRUE, xlab = \"mol/m3_phase\", ylab = \"depth (m)\",\n       grid = grid$x.mid,\n       which = model_species,\n       col = \"gray45\",\n       lty = 2,\n       lwd = 2,\n       cex = 1.5,\n       mfrow = c(1,1),\n       obs = std_black,\n       obspar = c(type = \"l\", lwd = 2, col = \"black\")\n  )\n}\n\nplot_std_rates &lt;- function(std, reactions, title = \"\") {\n  \n  # rcols &lt;- viridis::viridis(length(std$rates))\n  # \n  # matplot(y = grid$x.mid,\n  #         x = as.data.frame(std$rates),\n  #         type = \"l\", lwd=2, lty=1,\n  #         ylim = c(length,0), \n  #         col = rcols,\n  #         ylab=\"depth (m)\", \n  #         xlab=\"reaction rate (mol/(m3_bulk yr))\")\n  # \n  # legend(\n  #   x = \"bottomright\",\n  #   legend = names(std$rates),\n  #   lty = 1,\n  #   col = rcols &lt;- viridis::viridis(length(std$rates)),\n  #   lwd = 2\n  # )\n  \n  data &lt;- as.data.frame(std$rates)\n  data$depth &lt;- grid$x.mid\n  \n  fig &lt;- plot_ly(data, type = 'scatter', mode = 'lines', line = list(width = 3))\n  for (rate in reactions) {\n    fig &lt;- fig %&gt;% add_trace(y = ~depth, x = std$rates[[rate]], name = rate)\n  }\n  fig &lt;- fig %&gt;% layout(\n    title = title,\n    xaxis = list(title = \"reaction rate (mol/(m3_bulk yr))\"),\n    yaxis = list(title = \"depth (m)\", range = c(length,0)),\n    font = list(size = 16)\n  )\n    \n  fig\n}\n\n\n\n\nPlot Runge-Kutta Results\n\n\nCode\nplot_std_conc_evolution &lt;- function(std_matrix_list, selection, N_lines, grid) {\n  \n  data &lt;- std_matrix_list[[selection]]\n  \n  # number of available timesteps\n  available_timesteps &lt;- ncol(data)\n  \n  # selection of N_lines timesteps\n  selected_timesteps &lt;- floor(seq.int(1, available_timesteps, length.out = N_lines))\n  \n  # reduce data\n  data &lt;- data[,selected_timesteps]\n  \n  # plot\n  matplot(y = grid$x.mid,\n          x = data,\n          type = \"l\",\n          ylim = c(max(grid$x.mid), min(grid$x.mid)),\n          xlab = \"concentration (mol/m^3_phase)\",\n          ylab = \"depth (m)\",\n          main = selection)\n}\n\nplot_std_rate_evolution &lt;- function(std, selection, N_lines) {\n  \n  data &lt;- std$rates_split[[selection]]\n  \n  # number of available depths\n  available_depths &lt;- nrow(data)\n  \n  # selection of N_lines depths\n  selected_depths &lt;- floor(seq.int(1, available_depths, length.out = N_lines))\n  \n  # reduce data\n  data &lt;- data[selected_depths,]\n  \n  # plot\n  matplot(x = std$times,\n          y = t(data),\n          type = \"l\",\n          ylab = \"rate (mol/(m^3_phase * yr))\",\n          xlab = \"time (a)\",\n          main = selection)\n}\n\n\n\n\nPlot Speciation\n\n\nCode\nplot_speciation &lt;- function(speciation, grid) {\n\n  rcols &lt;- viridis::viridis(6)\n\n  matplot(y=grid$x.mid, x = speciation[,3:5],\n    type=\"l\", lwd=2, lty=1,\n    ylim=c(length,0),\n    col=c(rcols[3], rcols[6], rcols[1]),\n    ylab=\"depth (m)\", \n    xlab=\"mol/m3_phase\"\n  )\n  legend(\n    x = \"bottom\",\n    legend = c(\"H2CO3\", \"HCO3\", \"CO3\"),\n    lty = 1,\n    col = c(rcols[3], rcols[6], rcols[1]),\n    lwd = 2\n  )\n\n  matplot(y=grid$x.mid, x = speciation[,6:9],\n    type=\"l\", lwd=2, lty=1,\n    ylim=c(length,0), \n    col=c(rcols[3], rcols[6], rcols[1], rcols[4]),\n    ylab=\"depth (m)\", \n    xlab=\"mol/m3_phase\"\n  )\n  legend(\n    x = \"bottom\",\n    legend = c(\"H3PO4\", \"H2PO4-\", \"HPO42-\", \"PO43-\"),\n    lty = 1,\n    col = c(rcols[3], rcols[6], rcols[1], rcols[4]),\n    lwd = 2\n  )\n\n  matplot(y=grid$x.mid, x = speciation[,10:11],\n    type=\"l\", lwd=2, lty=1,\n    ylim=c(length,0), \n    col=c(rcols[3], rcols[6]),\n    ylab=\"depth (m)\", \n    xlab=\"mol/m3_phase\"\n  )\n  legend(\n    x = \"bottom\",\n    legend = c(\"HNO3\", \"NO3-\"),\n    lty = 1,\n    col = c(rcols[3], rcols[6]),\n    lwd = 2\n  )\n\n  matplot(y=grid$x.mid, x = speciation[,12:13],\n    type=\"l\", lwd=2, lty=1,\n    ylim=c(length,0), \n    col=c(rcols[3], rcols[6]),\n    ylab=\"depth (m)\", \n    xlab=\"mol/m3_phase\"\n  )\n  legend(\n    x = \"bottom\",\n    legend = c(\"NH4+\", \"NH3\"),\n    lty = 1,\n    col = c(rcols[3], rcols[6]),\n    lwd = 2\n  )\n\n  matplot(y=grid$x.mid, x = speciation[,14:16],\n    type=\"l\", lwd=2, lty=1,\n    ylim=c(length,0), \n    col=c(rcols[3], rcols[6], rcols[1]),\n    ylab=\"depth (m)\", \n    xlab=\"mol/m3_phase\"\n  )\n  legend(\n    x = \"bottom\",\n    legend = c(\"H2SO4\", \"HSO4-\", \"SO42-\"),\n    lty = 1,\n    col = c(rcols[3], rcols[6], rcols[1]),\n    lwd = 2\n  )\n\n  matplot(y=grid$x.mid, x = speciation[,17:19],\n    type=\"l\", lwd=2, lty=1,\n    ylim=c(length,0), \n    col=c(rcols[3], rcols[6], rcols[1]),\n    ylab=\"depth (m)\", \n    xlab=\"mol/m3_phase\"\n  )\n  legend(\n    x = \"bottom\",\n    legend = c(\"H2S\", \"HS-\", \"S2-\"),\n    lty = 1,\n    col = c(rcols[3], rcols[6], rcols[1]),\n    lwd = 2\n  )\n}"
  },
  {
    "objectID": "index.html#model-setup",
    "href": "index.html#model-setup",
    "title": "Fe Treatment Model",
    "section": "Model Setup",
    "text": "Model Setup\n\nGrid\n\nlength   &lt;- 0.1 # (m)\nN_grid   &lt;- 400 # (-)\n\ngrid     &lt;- setup.grid.1D(L = length, N = N_grid, dx.1=0.0005)\n\n\n\nPorosity / Solid Volume Fraction\n\nporFun.L  &lt;- function(x, por.SWI, por.deep, porcoef) {\n  return( por.deep + (por.SWI-por.deep) * exp(-x*porcoef) ) \n}\n\nporFun.S  &lt;- function(x, por.SWI, por.deep, porcoef) {\n  return( 1 - porFun.L(x, por.SWI, por.deep, porcoef) ) \n}\n\npor.swi  &lt;- 0.5\npor.deep &lt;- 0.5\n\ngrid.por &lt;- setup.prop.1D(func = porFun.L, grid = grid, por.SWI = por.swi,\n                           por.deep=por.deep, porcoef=100)\n\ngrid.svf  &lt;- setup.prop.1D(func = porFun.S, grid = grid, por.SWI = por.swi,\n                           por.deep=por.deep, porcoef=100)\n\nconversion_factors &lt;- list(\n  s2p = ((grid.svf$mid) / grid.por$mid), # conversion of x/m3_svf to x/m3_pw\n  p2s = (grid.por$mid / (grid.svf$mid))  # conversion of x/m3_pw  to x/m3_svf\n)\n\n\n\nAdvective Velocities\n\n# sedimentation velocity\nv &lt;- 5e-6*365  # (m/yr)\n\n# returns pore water advective velocities (u) and solid phase advective velocities (v)\nadvective_velocities &lt;- setup.compaction.1D(\n    v.0 = v,\n    por.0 = por.swi,\n    por.inf = por.deep,\n    por.grid = grid.por\n)\n\n\n\nDiffusion Coefficients\n\nsalinity    &lt;- 35 # (psu)\ntemperature &lt;- 20 # (dgC)\npressure    &lt;- 1.013253 # (bar)\nDb          &lt;- 0.01 * 5e-4 # mixing rate of the sediment; Bioturbation coefficient (m2/y)\nDb_mid      &lt;- 0.5  # middle of Db decreasing zone (m)\nDb_width    &lt;- 0.01 # width of Db decreasing zone (m)\n\ngrid.Db &lt;- setup.prop.1D(\n    func = p.sig,\n    y.0 = Db,\n    y.inf = 0,\n    x.L = Db_mid,\n    x.att = Db_width,\n    grid = grid\n)\n\ntortuosity_squared &lt;- 1-log(grid.por$int^2)\n\ns2yr &lt;- 3600*24*365.25\n\ndiffcoeff_species &lt;- c(\"HCO3\", \"HCO3\", \"CH4\", \"H2PO4\", \"NO3\", \"NH4\", \"SO4\",\n                       \"O2\", \"Mn\", \"Fe\", \"H2S\", \"N2\")\n\ndiffcoeffs &lt;- diffcoeff(\n  species = diffcoeff_species,\n  S = salinity,\n  t = temperature,\n  P = pressure\n)\n\ndiffusion_coefficients &lt;- list(\n  \n  # solute: molar diffusion coefficient / tortuosity**2 + bioturbation coefficient\n  # solid: bioturbation coefficient\n  \n  ALK   = diffcoeffs[[1]]  * s2yr / tortuosity_squared + grid.Db$int,\n  DIC   = diffcoeffs[[2]]  * s2yr / tortuosity_squared + grid.Db$int,\n  CH4   = diffcoeffs[[3]]  * s2yr / tortuosity_squared + grid.Db$int,\n  H2PO4 = diffcoeffs[[4]]  * s2yr / tortuosity_squared + grid.Db$int,\n  NO3   = diffcoeffs[[5]]  * s2yr / tortuosity_squared + grid.Db$int,\n  NH4   = diffcoeffs[[6]]  * s2yr / tortuosity_squared + grid.Db$int,\n  SO4   = diffcoeffs[[7]]  * s2yr / tortuosity_squared + grid.Db$int,\n  O2    = diffcoeffs[[8]]  * s2yr / tortuosity_squared + grid.Db$int,\n  Mn2   = diffcoeffs[[9]]  * s2yr / tortuosity_squared + grid.Db$int,\n  Fe2   = diffcoeffs[[10]] * s2yr / tortuosity_squared + grid.Db$int,\n  H2S   = diffcoeffs[[11]] * s2yr / tortuosity_squared + grid.Db$int,\n  N2    = diffcoeffs[[12]] * s2yr / tortuosity_squared + grid.Db$int,\n  solid = grid.Db$int\n    \n)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nBoundary Conditions\n\nboundary_conditions &lt;- c(\n  # Alkalinity in eq/m3?\n  ALK_up   = 1.8,\n  # Solutes: concentrations in mol m-3\n  DIC_up   = 2,\n  CH4_up   = 0,\n  H2PO4_up = 0.00235,\n  NO3_up   = 0.1,\n  NH4_up   = 0.001,\n  SO4_up   = 0.2,\n  O2_up    = 0.3,\n  N2_up    = 0,\n  Mn2_up   = 9.9e-5,\n  Fe2_up   = 8e-5,\n  H2S_up   = 0,\n  # Solids: flux in mol m-2 yr-1\n  OM_up      = 0.013 * 365,\n  MnO2_up    = 0.05,\n  FeOH3_up   = 0.2,\n  FeOH3_P_up = 0,\n  FeCO3_up   = 0,\n  S0_up      = 0,\n  FeS_up     = 0\n)\n\n\n\nReaction Parameters\n\ndry_density_sediment &lt;- 2700 # kg/m³\n\nreaction_parameter &lt;- c(\n  # OM degradation\n  ## reaction constants\n  k_alpha = 0.005 * 365, # yr-1\n  k_beta  = 0,#0.025,    # yr-1\n  ## composition of OM\n  OM_a    = 1,\n  OM_b    = 16 / 106,\n  OM_c    = 1 / 106,\n  ## limitation / inhibition constants (mol m-3)\n  K_O2    = 0.001,\n  K_NO3   = 0.001,\n  K_MnO2  = 0.001 * dry_density_sediment,#0.004 * dry_density_sediment,\n  K_FeOH3 = 0.001 * dry_density_sediment,#0.065 * dry_density_sediment,\n  K_SO4   = 0.1,\n  K_H3PO4 = 10^-5,\n  ## ratio of Fe to P in Fe(OH)_3(H3PO4)_lambda\n  lambda  = 0.6,\n\n  # Siderite Precipitation / Dissolution\n  k_precip_siderite = 1.8e2,  # mol m-3_sf yr-1\n  k_diss_siderite   = 2.5e-1, # yr-1\n  Ksp_siderite      = 10^(-10.4) * 1000^2, # mol2 m-6\n\n  # FeOH3 / FeOH3~H3PO4-Reduction coupled to Sulphide Oxidation\n  k_Fe_red_S_ox = 10**2, # m3 mol-1 yr-1\n\n  # FeOH3 / FeOH3~H3PO4-Formation\n  k_FeOH3_formation = 1.4e2, # m3 mol-1 yr-1\n\n  # H2S Oxidation\n  k_H2S_oxidation = 1.6e2, # m3_pw mol-1 yr-1\n\n  # SO4 Reduction Coupled to AOM\n  k_SO4_reduction = 50, # m3_pw mol-1 yr-1\n\n  # FeS Precipitation / Dissolution\n  k_precip_FeS = 2.5e-3, # mol m-3_sf yr-1\n  k_diss_FeS   = 1e-3,   # yr-1\n  Ksp_FeS      = 10^(-3.915) * 1000  # mol m-3\n)\n\n\n\nCollect Inputs\n\nratios_pH7 &lt;- speciation_ratios(pH = 7, tableau, tableau_species, logK)\n\nparameter &lt;- c(\n  N_grid = N_grid,\n  conversion_factors,\n  boundary_conditions,\n  reaction_parameter,\n  ratios_pH7,\n  logK = logK,\n  tableau = tableau\n)\n\nN_species &lt;- length(model_species)\n\n\n\nModel Function\n\n\nCode\nmodel &lt;- function (t, state, parms, diff_coeffs, adv_vel, solve_equilibrium, precipitation){\n  \n  with (as.list(parms),{\n    \n    # assign state variables\n    i &lt;- 1\n    # state variables for solutes are total amounts,\n    # but implicitly concentrations (total_amount/m³_pw)\n    ALK     &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1 # -TOT_H\n    DIC     &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1 # TOT_H2CO3\n    TOT_P   &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    TOT_N5  &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    TOT_N3  &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    TOT_S6  &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    TOT_S2  &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    CH4     &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    O2      &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    N2      &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    Mn2     &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    Fe2     &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    # state variables for solids are tableau-species concentrations (mol/m3_svf)\n    MnO2    &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    OM      &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    FeOH3   &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    FeOH3_P &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    FeCO3   &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    S0      &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    FeS     &lt;- state[((i-1) * N_grid + 1) : (i * N_grid)]; i &lt;- i + 1\n    \n    \n    # transport terms\n    tran.ALK     &lt;- tran.1D(C = ALK, C.up = ALK_up, D = diff_coeffs$ALK, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.DIC     &lt;- tran.1D(C = DIC, C.up = DIC_up, D = diff_coeffs$DIC, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.TOT_P   &lt;- tran.1D(C = TOT_P, C.up = H2PO4_up, D = diff_coeffs$H2PO4, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.TOT_N5  &lt;- tran.1D(C = TOT_N5, C.up = NO3_up, D = diff_coeffs$NO3, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.TOT_N3  &lt;- tran.1D(C = TOT_N3, C.up = NH4_up, D = diff_coeffs$NH4, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.TOT_S6  &lt;- tran.1D(C = TOT_S6, C.up = SO4_up, D = diff_coeffs$SO4, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.TOT_S2  &lt;- tran.1D(C = TOT_S2, C.up = H2S_up, D = diff_coeffs$H2S, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.CH4     &lt;- tran.1D(C = CH4, C.up = CH4_up, D = diff_coeffs$CH4, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n\n    tran.O2      &lt;- tran.1D(C = O2, C.up = O2_up, D = diff_coeffs$O2, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.N2      &lt;- tran.1D(C = N2, C.up = N2_up, D = diff_coeffs$N2, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.Mn2     &lt;- tran.1D(C = Mn2, C.up = Mn2_up, D = diff_coeffs$Mn2, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.Fe2     &lt;- tran.1D(C = Fe2, C.up = Fe2_up, D = diff_coeffs$Fe2, \n                            v = adv_vel$u, VF = grid.por, dx = grid)\n    \n    tran.MnO2    &lt;- tran.1D(C = MnO2, flux.up = MnO2_up, D = diff_coeffs$solid, \n                            v = adv_vel$v, VF = grid.svf, dx = grid)\n    \n    tran.OM      &lt;- tran.1D(C = OM, flux.up = OM_up, D = diff_coeffs$solid, \n                            v = adv_vel$v, VF = grid.svf, dx = grid)\n    \n    tran.FeOH3   &lt;- tran.1D(C = FeOH3, flux.up = FeOH3_up, D = diff_coeffs$solid, \n                            v = adv_vel$v, VF = grid.svf, dx = grid)\n    \n    tran.FeOH3_P &lt;- tran.1D(C = FeOH3_P, flux.up = FeOH3_P_up, D = diff_coeffs$solid, \n                            v = adv_vel$v, VF = grid.svf, dx = grid)\n    \n    tran.FeCO3   &lt;- tran.1D(C = FeCO3, flux.up = FeCO3_up, D = diff_coeffs$solid, \n                            v = adv_vel$v, VF = grid.svf, dx = grid)\n\n    tran.S0      &lt;- tran.1D(C = S0, flux.up = S0_up, D = diff_coeffs$solid, \n                            v = adv_vel$v, VF = grid.svf, dx = grid)\n\n    tran.FeS     &lt;- tran.1D(C = FeS, flux.up = FeS_up, D = diff_coeffs$solid, \n                            v = adv_vel$v, VF = grid.svf, dx = grid)\n    \n    \n    # calculate solute equilibrium species (solve the tableau)\n    if (solve_equilibrium) {\n      # 1) grep the solute total components; here we need TOT_H = - ALK\n      solute_totals &lt;- c(-ALK, DIC, TOT_P, TOT_N5, TOT_N3, TOT_S6, TOT_S2)\n      # 2) solve tableau\n      solute_equilibrium  &lt;- solve_tableau(solute_totals, tableau, logK, N_grid)\n      # 3) assign results\n      H     &lt;- solute_equilibrium$species_conc[,1]\n      pH    &lt;- -log10(H * 10^-3)\n      OH    &lt;- solute_equilibrium$species_conc[,2]\n      H2CO3 &lt;- solute_equilibrium$species_conc[,3]\n      HCO3  &lt;- solute_equilibrium$species_conc[,4]\n      CO3   &lt;- solute_equilibrium$species_conc[,5]\n      H3PO4 &lt;- solute_equilibrium$species_conc[,6]\n      H2PO4 &lt;- solute_equilibrium$species_conc[,7]\n      HPO4  &lt;- solute_equilibrium$species_conc[,8]\n      PO4   &lt;- solute_equilibrium$species_conc[,9]\n      HNO3  &lt;- solute_equilibrium$species_conc[,10]\n      NO3   &lt;- solute_equilibrium$species_conc[,11]\n      NH4   &lt;- solute_equilibrium$species_conc[,12]\n      NH3   &lt;- solute_equilibrium$species_conc[,13]\n      H2SO4 &lt;- solute_equilibrium$species_conc[,14]\n      HSO4  &lt;- solute_equilibrium$species_conc[,15]\n      SO4   &lt;- solute_equilibrium$species_conc[,16]\n      H2S   &lt;- solute_equilibrium$species_conc[,17]\n      HS    &lt;- solute_equilibrium$species_conc[,18]\n      S2    &lt;- solute_equilibrium$species_conc[,19]\n    } else {\n      solute_equilibrium &lt;- NA\n    }\n    \n    # FeOH3 fractions\n    FeOH3_tot &lt;- FeOH3 + FeOH3_P\n    chi &lt;- rep(1, length(FeOH3))\n    ind_valid &lt;- FeOH3_tot &gt; 0\n    chi[ind_valid] &lt;- FeOH3[ind_valid] / FeOH3_tot[ind_valid]\n    \n    # limitation & inhibition terms\n    L_O2    &lt;- O2   / (K_O2 + O2)\n    I_O2    &lt;- K_O2 / (K_O2 + O2)\n    \n    L_NO3   &lt;- TOT_N5 / (K_NO3 + TOT_N5)\n    I_NO3   &lt;- K_NO3 / (K_NO3 + TOT_N5)\n    \n    L_MnO2  &lt;- MnO2   / (K_MnO2 + MnO2)\n    I_MnO2  &lt;- K_MnO2 / (K_MnO2 + MnO2)\n    \n    L_FeOH3 &lt;- FeOH3_tot / (K_FeOH3 + FeOH3_tot)\n    I_FeOH3 &lt;- K_FeOH3 / (K_FeOH3 + FeOH3_tot)\n    \n    L_SO4   &lt;- TOT_S6 / (K_SO4 + TOT_S6)\n    I_SO4   &lt;- K_SO4 / (K_SO4 + TOT_S6)\n    \n    L_H3PO4 &lt;- TOT_P   / (K_H3PO4 + TOT_P)\n    I_H3PO4 &lt;- K_H3PO4 / (K_H3PO4 + TOT_P)\n    \n    # Reaction Rates\n    ## OM Degradation\n    R1 &lt;- k_alpha * OM * L_O2\n    R2 &lt;- k_alpha * OM * L_NO3                            * I_O2\n    R3 &lt;- k_alpha * OM * L_MnO2                   * I_NO3 * I_O2\n    R4 &lt;- k_alpha * OM * L_FeOH3         * I_MnO2 * I_NO3 * I_O2\n    R5 &lt;- k_alpha * OM * L_SO4 * I_FeOH3 * I_MnO2 * I_NO3 * I_O2\n    R6 &lt;- k_alpha * OM * I_SO4 * I_FeOH3 * I_MnO2 * I_NO3 * I_O2\n\n    ## Siderite: R7 = precipitation, R8 = dissolution\n    if (precipitation & solve_equilibrium) {\n      omega_siderite &lt;- (Fe2 * CO3) / Ksp_siderite\n    } else if (precipitation) {\n      omega_siderite &lt;- (Fe2 * (DIC * f_CO3)) / Ksp_siderite\n    }\n    else {\n      omega_siderite &lt;- rep(1, N_grid)\n    }\n    R7 &lt;- ifelse(omega_siderite &gt; 1, k_precip_siderite * (omega_siderite - 1)^2, 0)\n    R8 &lt;- ifelse(omega_siderite &lt; 1, k_diss_siderite * FeCO3 * (1 - omega_siderite)^2, 0)\n\n    ## FeOH3 / FeOH3~H3PO4-Reduction coupled to Sulphide Oxidation\n    R9 &lt;- k_Fe_red_S_ox * FeOH3_tot * TOT_S2\n\n    ## FeOH3 / FeOH3~H3PO4-Formation\n    R10 &lt;- k_FeOH3_formation * O2 * Fe2\n\n    ## H2S Oxidation\n    R11 &lt;- k_H2S_oxidation * O2 * TOT_S2\n\n    ## SO4-Reduction Coupeld to AOM\n    if (solve_equilibrium) {\n      R12 &lt;- k_SO4_reduction * CH4 * SO4\n    } else {\n      R12 &lt;- k_SO4_reduction * CH4 * (TOT_S6 * 1)\n    }\n\n    ## FeS: R13 = precipitation, R14 = dissolution\n    if (precipitation & solve_equilibrium) {\n      omega_FeS &lt;- (Fe2 * HS / H) / Ksp_FeS\n    } else if (precipitation) {\n      omega_FeS &lt;- (Fe2 * (TOT_S2 * f_HS / fixed_H)) / Ksp_FeS\n    }\n    else {\n      omega_FeS &lt;- rep(1, N_grid)\n    }\n    R13 &lt;- ifelse(omega_FeS &gt; 1, k_precip_FeS * (omega_FeS - 1)^2, 0)\n    R14 &lt;- ifelse(omega_FeS &lt; 1, k_diss_FeS * FeS * (1 - omega_FeS)^2, 0)\n\n    \n    # change of species concentration due to reactions\n    ## solutes step1: change of slow-reaction-species (srs), the ones for which\n    ## the reactions are formulated, according to reaction stoichiometry\n    R.srs_O2    &lt;- (- s2p * R1                   # OM Degradation\n                    - 1 * R10\n                    - 2 * R11)\n    R.srs_CO2   &lt;- (s2p * (R1 + R2 + R3 + R4 + R5 + 1/2 * R6)\n                    - s2p * R7 + s2p * R8  # Siderite Precipitation / Dissolution\n                    + 1 * R12)\n    R.srs_NH3   &lt;- OM_b * s2p * (R1 + R2 + R3 + R4 + R5 + R6)\n    R.srs_H3PO4 &lt;- (s2p * ( OM_c * (R1 + R2 + R3 + R5 + R6) +\n                      (OM_c + (1 - chi) * 4 * lambda) * R4 )\n                    + 2 * (1 - chi) * lambda * s2p * R9\n                    - 4 * lambda * L_H3PO4 * R10)\n    R.srs_HNO3  &lt;- - 4/5 * s2p * R2\n    R.srs_N2    &lt;- 2/5 * s2p * R2\n    R.srs_FeOH2 &lt;- (4 * s2p * R4                # OM degradation\n                    - s2p * R7 + s2p * R8       # Siderite Precipitation / Dissolution\n                    + 2 * s2p * R9\n                    - 4 * R10\n                    - s2p * R13 + s2p * R14)\n    R.srs_MnOH2 &lt;- 2 * s2p * R3\n    R.srs_H2SO4 &lt;- (- 1/2 * s2p * R5\n                    + 1 * R11\n                    - 1 * R12)\n    R.srs_H2S   &lt;- (1/2 * s2p * R5\n                    - 1 * s2p * R9\n                    - 1 * R11\n                    + 1 * R12\n                    - s2p * R13 + s2p * R14)\n    R.srs_CH4   &lt;- (1/2 * s2p * R6\n                    - 1 * R12)\n    \n    ## solutes step2: change of tableau-components = model species\n    ## translation of change of slow-reaction-species to change of \n    ## tableau components using the translation table\n    ## here the component-total \"H\" is already converted to alkalinity (*-1)\n    R.ALK   &lt;- -1 * (- R.srs_NH3 + R.srs_H3PO4 + R.srs_HNO3 - 2 * R.srs_FeOH2\n                     - 2 * R.srs_MnOH2 + 2 * R.srs_H2SO4)\n    R.DIC    &lt;- R.srs_CO2\n    R.CH4    &lt;- R.srs_CH4\n    R.TOT_P  &lt;- R.srs_H3PO4\n    R.TOT_N5 &lt;- R.srs_HNO3\n    R.TOT_N3 &lt;- R.srs_NH3\n    R.TOT_S6 &lt;- R.srs_H2SO4\n    R.TOT_S2 &lt;- R.srs_H2S\n    R.O2     &lt;- R.srs_O2\n    R.N2     &lt;- R.srs_N2\n    R.Mn2    &lt;- R.srs_MnOH2\n    R.Fe2    &lt;- R.srs_FeOH2\n    \n    ## solids\n    R.OM &lt;- - R1 - R2 - R3 - R4 - R5 - R6\n    R.MnO2 &lt;- - 2 * R3\n    R.FeOH3 &lt;- (- 4 * chi * R4\n                - 2 * chi * R9\n                + 4 * (1 - L_H3PO4) * p2s * R10)\n    R.FeOH3_P &lt;- (- 4 * (1 - chi) * R4\n                  - 2 * (1 - chi) * R9\n                  + 4 * L_H3PO4 * p2s * R10)\n    R.FeCO3 &lt;- R7 - R8\n    R.S0 &lt;- R9\n    R.FeS &lt;- R13 - R14\n    \n    # total change in concentration of model species\n    dCdt.ALK    &lt;- R.ALK + tran.ALK$dC\n    dCdt.DIC    &lt;- R.DIC + tran.DIC$dC\n    dCdt.CH4    &lt;- R.CH4 + tran.CH4$dC\n    dCdt.TOT_P  &lt;- R.TOT_P + tran.TOT_P$dC\n    dCdt.TOT_N5 &lt;- R.TOT_N5 + tran.TOT_N5$dC\n    dCdt.TOT_N3 &lt;- R.TOT_N3 + tran.TOT_N3$dC\n    dCdt.N2     &lt;- R.N2  + tran.N2$dC\n    dCdt.TOT_S6 &lt;- R.TOT_S6 + tran.TOT_S6$dC\n    dCdt.TOT_S2 &lt;- R.TOT_S2 + tran.TOT_S2$dC\n    dCdt.O2     &lt;- R.O2 + tran.O2$dC\n    dCdt.Mn2    &lt;- R.Mn2 + tran.Mn2$dC\n    dCdt.Fe2    &lt;- R.Fe2 + tran.Fe2$dC\n    dCdt.OM     &lt;- R.OM + tran.OM$dC\n    dCdt.MnO2   &lt;- R.MnO2 + tran.MnO2$dC\n    dCdt.FeOH3  &lt;- R.FeOH3 + tran.FeOH3$dC\n    dCdt.FeOH3_P &lt;- R.FeOH3_P + tran.FeOH3_P$dC\n    dCdt.FeCO3  &lt;- R.FeCO3 + tran.FeCO3$dC\n    dCdt.S0     &lt;- R.S0 + tran.S0$dC\n    dCdt.FeS    &lt;- R.FeS + tran.FeS$dC\n    \n    # characteristic time scales\n    # if dCdt.X = 0 -&gt; timescale will be Inf\n    time_scales &lt;- c(\n      ALK = ALK / dCdt.ALK,\n      DIC = DIC / dCdt.DIC,\n      CH4 = CH4 / dCdt.CH4,\n      TOT_P = TOT_P / dCdt.TOT_P,\n      TOT_N5 = TOT_N5 / dCdt.TOT_N5,\n      TOT_N3 = TOT_N3 / dCdt.TOT_N3,\n      N2 = N2 / dCdt.N2,\n      TOT_S6 = TOT_S6 / dCdt.TOT_S6,\n      TOT_S2 = TOT_S2 / dCdt.TOT_S2,\n      O2 = O2 / dCdt.O2,\n      Mn2 = Mn2 / dCdt.Mn2,\n      Fe2 = Fe2 / dCdt.Fe2,\n      OM = OM / dCdt.OM,\n      MnO2 = MnO2 / dCdt.MnO2,\n      FeOH3 = FeOH3 / dCdt.FeOH3,\n      FeOH3_P = FeOH3_P / dCdt.FeOH3_P,\n      FeCO3 = FeCO3 / dCdt.FeCO3,\n      S0 = S0 / dCdt.S0,\n      FeS = FeS / dCdt.FeS\n    )\n    # but we need to take the absolute value to find the correct minimum\n    time_scales &lt;- abs(time_scales)\n    # set NaN values to a number (???)\n    time_scales[is.na(time_scales)] &lt;- 100\n    # set 0 to a small number\n    time_scales[time_scales == 0] &lt;- 1e-10\n\n    return(\n      list(\n        c(\n          dCdt.ALK = dCdt.ALK,\n          dCdt.DIC = dCdt.DIC,\n          dCdt.TOT_P = dCdt.TOT_P,\n          dCdt.TOT_N5 = dCdt.TOT_N5,\n          dCdt.TOT_N3 = dCdt.TOT_N3,\n          dCdt.TOT_S6 = dCdt.TOT_S6,\n          dCdt.TOT_S2 = dCdt.TOT_S2,\n          dCdt.CH4 = dCdt.CH4,\n          dCdt.O2 = dCdt.O2,\n          dCdt.N2 = dCdt.N2,\n          dCdt.Mn2 = dCdt.Mn2,\n          dCdt.Fe2 = dCdt.Fe2,\n          dCdt.MnO2 = dCdt.MnO2,\n          dCdt.OM = dCdt.OM,\n          dCdt.FeOH3 = dCdt.FeOH3,\n          dCdt.FeOH3_P = dCdt.FeOH3_P,\n          dCdt.FeCO3 = dCdt.FeCO3,\n          dCdt.S0 = dCdt.S0,\n          dCdt.FeS = dCdt.FeS\n        ),\n        transport = list(\n          tran.ALK = tran.ALK,\n          tran.DIC = tran.DIC,\n          tran.TOT_P = tran.TOT_P,\n          tran.TOT_N5 = tran.TOT_N5,\n          tran.TOT_N3 = tran.TOT_N3,\n          tran.TOT_S6 = tran.TOT_S6,\n          tran.TOT_S2 = tran.TOT_S2,\n          tran.CH4 = tran.CH4,\n          tran.O2 = tran.O2,\n          tran.N2 = tran.N2,\n          tran.Mn2 = tran.Mn2,\n          tran.Fe2 = tran.Fe2,\n          tran.MnO2 = tran.MnO2,\n          tran.OM = tran.OM,\n          tran.FeOH3 = tran.FeOH3,\n          tran.FeOH3_P = tran.FeOH3_P,\n          tran.FeCO3 = tran.FeCO3,\n          tran.S0 = tran.S0,\n          tran.FeS = tran.FeS\n        ),\n        sumR = list(\n          R.ALK     = R.ALK * grid.por$mid,\n          R.DIC     = R.DIC * grid.por$mid,\n          R.TOT_P   = R.TOT_P * grid.por$mid,\n          R.TOT_N5  = R.TOT_N5 * grid.por$mid,\n          R.TOT_N3  = R.TOT_N3 * grid.por$mid,\n          R.TOT_S6  = R.TOT_S6 * grid.por$mid,\n          R.TOT_S2  = R.TOT_S2 * grid.por$mid,\n          R.CH4     = R.CH4 * grid.por$mid,\n          R.O2      = R.O2 * grid.por$mid,\n          R.N2      = R.N2 * grid.por$mid,\n          R.Mn2     = R.Mn2 * grid.por$mid,\n          R.Fe2     = R.Fe2 * grid.por$mid,\n          R.MnO2    = R.MnO2 * grid.svf$mid,\n          R.OM      = R.OM * grid.svf$mid,\n          R.FeOH3   = R.FeOH3 * grid.svf$mid,\n          R.FeOH3_P = R.FeOH3_P * grid.svf$mid,\n          R.FeCO3   = R.FeCO3 * grid.svf$mid,\n          R.S0      = R.S0 * grid.svf$mid,\n          R.FeS     = R.FeS * grid.svf$mid\n        ),\n        rates = list(\n          R1  = R1  * grid.svf$mid,\n          R2  = R2  * grid.svf$mid,\n          R3  = R3  * grid.svf$mid,\n          R4  = R4  * grid.svf$mid,\n          R5  = R5  * grid.svf$mid,\n          R9  = R9  * grid.svf$mid,\n          R6  = R6  * grid.svf$mid,\n          R7  = R7  * grid.svf$mid,\n          R8  = R8  * grid.svf$mid,\n          R10 = R10 * grid.svf$mid,\n          R11 = R11 * grid.por$mid,\n          R12 = R12 * grid.por$mid,\n          R13 = R13 * grid.svf$mid,\n          R14 = R14 * grid.svf$mid\n        ),\n        omega = list(\n          siderite = omega_siderite,\n          FeS = omega_FeS\n        ),\n        solute_equilibrium = solute_equilibrium,\n        time_scales = time_scales\n      )\n    )\n })\n}"
  },
  {
    "objectID": "index.html#solve-model",
    "href": "index.html#solve-model",
    "title": "Fe Treatment Model",
    "section": "Solve Model",
    "text": "Solve Model\n\n1) Steady State\nSteady State is found in a two step procedure:\n\nSolve steady state without equilibrium solver. All reactions are controlled by component-totals. If necessary, pH dependent speciation is estimated for pH = 7.\nSolve steady state with equilibrium solver. All reaction now are controlled by the actual concentrations.\n\n\ninitial &lt;- rep(1e-4, N_grid * N_species)\n\nif (run_std1) {\n  std1 &lt;- steady.1D(\n    y = initial,\n    func = model,\n    parms = parameter, \n    dimens = N_grid,\n    nspec = N_species,\n    names = model_species,\n    positive = TRUE,\n    method = \"stodes\",\n    diff_coeffs = diffusion_coefficients,\n    adv_vel = advective_velocities,\n    solve_equilibrium = FALSE,\n    precipitation = TRUE\n  )\n\n  saveRDS(std1, \"last_results/std1.rds\")\n} else {\n  std1 &lt;- readRDS(\"last_results/std1.rds\")\n}\n\n\nif (run_std2) {\n  std2 &lt;- steady.1D(\n    y = std1$y,\n    func = model,\n    parms = parameter,\n    dimens = N_grid,\n    nspec = N_species,\n    names = model_species,\n    positive = TRUE,\n    method = \"stode\", # stode gives back result, even if steady state is not reached\n                      # stodes does not return intermediate result\n    maxiter = 100,\n    diff_coeffs = diffusion_coefficients,\n    adv_vel = advective_velocities,\n    solve_equilibrium = TRUE,\n    precipitation = TRUE\n  )\n\n  saveRDS(std2, \"last_results/std2.rds\")\n} else {\n  std2 &lt;- readRDS(\"last_results/std2.rds\")\n}\n\n\nProfiles: Component-Totals\n\nstd1: gray\nstd2: black\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nProfiles: Speciation\n\nstd1std2\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nProfile: pH\n\n\n\n\n\n\n\nProfiles: Saturation\n\n\n\n\n\n\n\n\n\n\n\n\nProfiles: Reaction Rates\n\nOM Degradation\n\n\nstd1\n\n\n\n\n\n\n\nstd2\n\n\n\n\n\n\n\n\n\n\n\n\nH2S Oxidation\n\n\nstd1\n\n\n\n\n\n\n\nstd2\n\n\n\n\n\n\n\n\n\n\n\n\nSO4-Reduction Coupled to AOM\n\n\nstd1\n\n\n\n\n\n\n\nstd2\n\n\n\n\n\n\n\n\n\n\n\n\nSiderite Precipitation\n\n\nstd1\n\n\n\n\n\n\n\nstd2\n\n\n\n\n\n\n\n\n\n\n\n\nFeOH3 / FeOH3~H3PO4-reduction coupled to sulphide oxidation\n\n\nstd1\n\n\n\n\n\n\n\nstd2\n\n\n\n\n\n\n\n\n\n\n\n\nFeOH3 / FeOH3~H3PO4-formation\n\n\nstd1\n\n\n\n\n\n\n\nstd2\n\n\n\n\n\n\n\n\n\n\n\n\nFeS Precipitation / Dissolution\n\n\nstd1\n\n\n\n\n\n\n\nstd2"
  },
  {
    "objectID": "index.html#mass-balances",
    "href": "index.html#mass-balances",
    "title": "Fe Treatment Model",
    "section": "Mass Balances",
    "text": "Mass Balances\n\nSpecies-based Mass Balances\nThe change in concentration of a species \\(i\\), integrated over depth and in relation to the area \\(A\\) is\n\\[\\frac{dC_{A,i}}{dt} \\; \\left( \\frac{mol}{m^2 \\cdot a} \\right) = J(a)_i - J(b)_i + \\int_{a}^b \\Psi \\sum R_i\\]\nwith\n\n\\(J(a)_i\\): flux of species \\(i\\) across upper boundary\n\\(J(b)_i\\): flux of species \\(i\\) across lower boundary\n\\(\\Psi\\): volume fraction.\n\n\n\nCode\nspecies_mass_balance &lt;- function(species_vector, std, grid) {\n  \n  species_mass_balance_inner &lt;- function(species, std, grid) {\n  \n    tran.species &lt;- paste0(\"tran.\", species)\n    flux_up   &lt;- std$transport[[tran.species]]$flux.up\n    flux_down &lt;- std$transport[[tran.species]]$flux.down\n    netto_flux &lt;- flux_up - flux_down\n    \n    R.species &lt;- paste0(\"R.\", species)\n    sumR_integrated &lt;- sum(std$sumR[[R.species]] * grid$dx)\n    \n    bilanz &lt;- netto_flux + sumR_integrated\n    \n    return(data.frame(\n      species = species,\n      flux_up = flux_up,\n      flux_down = flux_down,\n      netto_flux = netto_flux,\n      sumR_integrated = sumR_integrated,\n      bilanz = bilanz\n    ))\n  }\n  \n  species_based_mass_balance &lt;- data.frame(\n  \"Species\" = NULL,\n  \"Flux up\" = NULL,\n  \"Flux down\" = NULL,\n  \"Netto Flux\" = NULL,\n  \"Integral Sum R\" = NULL,\n  \"Bilanz\" = NULL\n  )\n  \n  for (species in species_vector) {\n    species_based_mass_balance &lt;- rbind(\n      species_based_mass_balance,\n      species_mass_balance_inner(species, std, grid)\n    )\n  }\n  \n  return(species_based_mass_balance)\n}\n\n\n\n\n\nstd1 (mol m-2 yr-1)\n\n\nspecies\nflux_up\nflux_down\nnetto_flux\nsumR_integrated\nbilanz\n\n\n\n\nALK\n-1.68932\n2.398e-03\n-1.692e+00\n1.692e+00\n-4.441e-15\n\n\nDIC\n-4.43905\n3.199e-03\n-4.442e+00\n4.442e+00\n-1.155e-14\n\n\nTOT_P\n-0.04474\n2.010e-05\n-4.476e-02\n4.476e-02\n-6.939e-18\n\n\nTOT_N5\n0.34253\n3.816e-16\n3.425e-01\n-3.425e-01\n-3.331e-16\n\n\nTOT_N3\n-0.71609\n1.366e-04\n-7.162e-01\n7.162e-01\n0.000e+00\n\n\nTOT_S6\n0.17139\n5.610e-06\n1.714e-01\n-1.714e-01\n-3.886e-16\n\n\nTOT_S2\n-0.05253\n6.620e-06\n-5.254e-02\n5.254e-02\n-2.359e-16\n\n\nCH4\n-0.27560\n1.417e-04\n-2.757e-01\n2.757e-01\n0.000e+00\n\n\nO2\n3.37924\n1.992e-18\n3.379e+00\n-3.379e+00\n1.332e-15\n\n\nN2\n-0.17122\n4.818e-05\n-1.713e-01\n1.713e-01\n2.776e-17\n\n\nMn2\n-0.04996\n3.789e-05\n-5.000e-02\n5.000e-02\n-6.939e-18\n\n\nFe2\n-0.11746\n2.363e-05\n-1.175e-01\n1.175e-01\n-3.261e-15\n\n\nMnO2\n0.05000\n1.477e-21\n5.000e-02\n-5.000e-02\n6.939e-18\n\n\nOM\n4.74500\n2.276e-19\n4.745e+00\n-4.745e+00\n8.882e-16\n\n\nFeOH3\n0.20000\n9.017e-21\n2.000e-01\n-2.000e-01\n0.000e+00\n\n\nFeOH3_P\n0.00000\n1.986e-17\n-1.986e-17\n2.364e-17\n3.775e-18\n\n\nFeCO3\n0.00000\n2.700e-02\n-2.700e-02\n2.700e-02\n3.036e-15\n\n\nS0\n0.00000\n6.333e-02\n-6.333e-02\n6.333e-02\n0.000e+00\n\n\nFeS\n0.00000\n5.551e-02\n-5.551e-02\n5.551e-02\n2.429e-16\n\n\n\n\n\n\nstd2 (mol m-2 yr-1)\n\n\nspecies\nflux_up\nflux_down\nnetto_flux\nsumR_integrated\nbilanz\n\n\n\n\nALK\n-1.73223\n2.411e-03\n-1.735e+00\n1.735e+00\n-7.994e-15\n\n\nDIC\n-4.45465\n3.203e-03\n-4.458e+00\n4.458e+00\n5.329e-15\n\n\nTOT_P\n-0.04474\n2.013e-05\n-4.476e-02\n4.476e-02\n-6.939e-18\n\n\nTOT_N5\n0.34254\n3.815e-16\n3.425e-01\n-3.425e-01\n4.996e-16\n\n\nTOT_N3\n-0.71609\n1.366e-04\n-7.162e-01\n7.162e-01\n0.000e+00\n\n\nTOT_S6\n0.17151\n5.599e-06\n1.715e-01\n-1.715e-01\n1.665e-16\n\n\nTOT_S2\n-0.05624\n8.944e-06\n-5.625e-02\n5.625e-02\n-3.456e-15\n\n\nCH4\n-0.27592\n1.419e-04\n-2.761e-01\n2.761e-01\n0.000e+00\n\n\nO2\n3.37929\n1.611e-18\n3.379e+00\n-3.379e+00\n-1.332e-15\n\n\nN2\n-0.17122\n4.818e-05\n-1.713e-01\n1.713e-01\n0.000e+00\n\n\nMn2\n-0.04996\n3.789e-05\n-5.000e-02\n5.000e-02\n0.000e+00\n\n\nFe2\n-0.13879\n3.460e-05\n-1.388e-01\n1.388e-01\n-3.220e-15\n\n\nMnO2\n0.05000\n1.476e-21\n5.000e-02\n-5.000e-02\n0.000e+00\n\n\nOM\n4.74500\n2.276e-19\n4.745e+00\n-4.745e+00\n0.000e+00\n\n\nFeOH3\n0.20000\n7.900e-21\n2.000e-01\n-2.000e-01\n-2.776e-17\n\n\nFeOH3_P\n0.00000\n1.743e-17\n-1.743e-17\n2.007e-17\n2.641e-18\n\n\nFeCO3\n0.00000\n1.109e-02\n-1.109e-02\n1.109e-02\n-2.082e-16\n\n\nS0\n0.00000\n6.516e-02\n-6.516e-02\n6.516e-02\n1.388e-17\n\n\nFeS\n0.00000\n5.009e-02\n-5.009e-02\n5.009e-02\n3.449e-15\n\n\n\n\n\n\n\nElement-based Mass Balances\nThe total amount of an chemical element \\(e\\) is not influenced by chemical reactions. Therefore, the over the depth integrated and summed up reaction rates of of species \\(i\\) that contain a chemical element is 0.\n\\[\\sum \\left[ \\frac{e}{i} \\cdot \\int_{a}^b \\Psi \\sum R_i \\right]_e = 0\\]\nFrom this follows, that under stationary conditions the flux in and out of the sediment domain cancel out.\n\\[\\frac{dC_{A,e}}{dt} \\; \\left( \\frac{mol}{m^2 \\cdot a} \\right) = J(a)_e - J(b)_e = 0\\]\n\n\nCode\nelement_mass_balance &lt;- function(elemental_composition, std, grid) {\n  \n  species_sumR_integrated &lt;- function(species, std, grid) {\n    \n    R.species &lt;- paste0(\"R.\", species)\n    sumR_integrated &lt;- sum(std$sumR[[R.species]] * grid$dx)\n    \n    return(sumR_integrated)\n  }\n\n  species_boundary_fluxes &lt;- function(species, std, grid) {\n  \n    tran.species &lt;- paste0(\"tran.\", species)\n    flux_up   &lt;- std$transport[[tran.species]]$flux.up\n    flux_down &lt;- std$transport[[tran.species]]$flux.down\n    \n    return(list(\n      flux_up = flux_up,\n      flux_down = flux_down\n    ))\n  }\n\n  elements &lt;- names(elemental_composition)\n  \n  overview &lt;- data.frame(\n    \"Element\" = NULL,\n    \"Netto Flux\" = NULL,\n    \"Integral Sum R\" = NULL\n  )\n\n  detailed &lt;- list()\n  \n  for (element in elements) {\n\n    composition &lt;- elemental_composition[[element]]\n\n    detailed_part &lt;- data.frame(\n      \"Species\" = NULL,\n      \"Flux up\" = NULL,\n      \"Flux down\" = NULL,\n      \"Intergal Sum R\" = NULL\n    )\n\n    # for every species in which an element is present ...\n    for (i in seq_len(nrow(composition))) {\n      species &lt;- composition$species[i]\n      stoic   &lt;- composition$stoic[i]\n\n      sumR &lt;- species_sumR_integrated(species, std, grid) * stoic\n\n      boundary_fluxes &lt;- species_boundary_fluxes(species, std, grid)\n      flux_up &lt;- boundary_fluxes$flux_up * stoic\n      flux_down &lt;- boundary_fluxes$flux_down * stoic\n\n      detailed_part &lt;- rbind(\n        detailed_part,\n        data.frame(\n          \"Species\" = species,\n          \"Flux up\" = flux_up,\n          \"Flux down\" = flux_down,\n          \"Integral Sum R\" = sumR\n        )\n      )\n    }\n\n    detailed[[element]] &lt;- detailed_part\n\n    net_flux &lt;- sum(detailed_part[[\"Flux.up\"]]) - sum(detailed_part[[\"Flux.down\"]])\n    net_rate &lt;- sum(detailed_part[[\"Integral.Sum.R\"]])\n\n    overview &lt;- rbind(\n      overview,\n      data.frame(\n        \"Element\" = element,\n        \"Netto Flux\" = net_flux,\n        \"Integral Sum R\" = net_rate\n      )\n    )\n  }\n  \n  return(list(\n    overview = overview,\n    detailed = detailed\n  ))\n}\n\n\n\nElemental Composition of Model-Species\n\n\n\n\nC\n\n\nspecies\nstoic\n\n\n\n\nDIC\n1\n\n\nCH4\n1\n\n\nOM\n1\n\n\nFeCO3\n1\n\n\n\n\n\n\nN\n\n\nspecies\nstoic\n\n\n\n\nTOT_N5\n1.00000\n\n\nTOT_N3\n1.00000\n\n\nN2\n2.00000\n\n\nOM\n0.15094\n\n\n\n\n\n\nP\n\n\nspecies\nstoic\n\n\n\n\nTOT_P\n1.00000\n\n\nOM\n0.00943\n\n\nFeOH3_P\n0.60000\n\n\n\n\n\n\n\n\nS\n\n\nspecies\nstoic\n\n\n\n\nTOT_S6\n1\n\n\nTOT_S2\n1\n\n\nS0\n1\n\n\nFeS\n1\n\n\n\n\n\n\nFe\n\n\nspecies\nstoic\n\n\n\n\nFe2\n1\n\n\nFeOH3\n1\n\n\nFeOH3_P\n1\n\n\nFeCO3\n1\n\n\nFeS\n1\n\n\n\n\n\n\nMn\n\n\nspecies\nstoic\n\n\n\n\nMn2\n1\n\n\nMnO2\n1\n\n\n\n\n\n\n\n\nOverview Mass Balances\n\n\n\n\nstd1 (mol m-2 yr-1)\n\n\nElement\nNetto.Flux\nIntegral.Sum.R\n\n\n\n\nC\n-8.2e-15\n2.5e-16\n\n\nN\n-3.3e-16\n1.1e-16\n\n\nP\n5.4e-18\n3.0e-19\n\n\nS\n-3.7e-16\n-6.9e-18\n\n\nFe\n0.0e+00\n1.3e-17\n\n\nMn\n-6.5e-19\n0.0e+00\n\n\n\n\n\n\nstd2 (mol m-2 yr-1)\n\n\nElement\nNetto.Flux\nIntegral.Sum.R\n\n\n\n\nC\n4.4e-15\n6.1e-16\n\n\nN\n4.7e-16\n0.0e+00\n\n\nP\n-5.2e-18\n-1.8e-18\n\n\nS\n1.7e-16\n0.0e+00\n\n\nFe\n-6.9e-18\n2.7e-18\n\n\nMn\n1.6e-18\n0.0e+00\n\n\n\n\n\n\n\n\nDetailed Mass Balances\n\nstd1\n\n\n\n\nstd1: C (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nDIC\n-4.43905\n0.00320\n4.44225\n\n\nCH4\n-0.27560\n0.00014\n0.27575\n\n\nOM\n4.74500\n0.00000\n-4.74500\n\n\nFeCO3\n0.00000\n0.02700\n0.02700\n\n\n\n\n\n\nstd1: N (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nTOT_N5\n0.34253\n0.00000\n-0.34253\n\n\nTOT_N3\n-0.71609\n0.00014\n0.71623\n\n\nN2\n-0.34243\n0.00010\n0.34253\n\n\nOM\n0.71623\n0.00000\n-0.71623\n\n\n\n\n\n\nstd1: P (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nTOT_P\n-0.04474\n2e-05\n0.04476\n\n\nOM\n0.04476\n0e+00\n-0.04476\n\n\nFeOH3_P\n0.00000\n0e+00\n0.00000\n\n\n\n\n\n\n\n\nstd1: S (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nTOT_S6\n0.17139\n0.00001\n-0.17138\n\n\nTOT_S2\n-0.05253\n0.00001\n0.05254\n\n\nS0\n0.00000\n0.06333\n0.06333\n\n\nFeS\n0.00000\n0.05551\n0.05551\n\n\n\n\n\n\nstd1: Fe (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nFe2\n-0.11746\n0.00002\n0.11748\n\n\nFeOH3\n0.20000\n0.00000\n-0.20000\n\n\nFeOH3_P\n0.00000\n0.00000\n0.00000\n\n\nFeCO3\n0.00000\n0.02700\n0.02700\n\n\nFeS\n0.00000\n0.05551\n0.05551\n\n\n\n\n\n\nstd1: Mn (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nMn2\n-0.04996\n4e-05\n0.05\n\n\nMnO2\n0.05000\n0e+00\n-0.05\n\n\n\n\n\n\n\n\nstd2\n\n\n\n\nstd2: C (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nDIC\n-4.45465\n0.00320\n4.45786\n\n\nCH4\n-0.27592\n0.00014\n0.27606\n\n\nOM\n4.74500\n0.00000\n-4.74500\n\n\nFeCO3\n0.00000\n0.01109\n0.01109\n\n\n\n\n\n\nstd2: N (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nTOT_N5\n0.34254\n0.00000\n-0.34254\n\n\nTOT_N3\n-0.71609\n0.00014\n0.71623\n\n\nN2\n-0.34244\n0.00010\n0.34254\n\n\nOM\n0.71623\n0.00000\n-0.71623\n\n\n\n\n\n\nstd2: P (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nTOT_P\n-0.04474\n2e-05\n0.04476\n\n\nOM\n0.04476\n0e+00\n-0.04476\n\n\nFeOH3_P\n0.00000\n0e+00\n0.00000\n\n\n\n\n\n\n\n\nstd2: S (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nTOT_S6\n0.17151\n0.00001\n-0.17150\n\n\nTOT_S2\n-0.05624\n0.00001\n0.05625\n\n\nS0\n0.00000\n0.06516\n0.06516\n\n\nFeS\n0.00000\n0.05009\n0.05009\n\n\n\n\n\n\nstd2: Fe (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nFe2\n-0.13879\n0.00003\n0.13882\n\n\nFeOH3\n0.20000\n0.00000\n-0.20000\n\n\nFeOH3_P\n0.00000\n0.00000\n0.00000\n\n\nFeCO3\n0.00000\n0.01109\n0.01109\n\n\nFeS\n0.00000\n0.05009\n0.05009\n\n\n\n\n\n\nstd2: Mn (mol m-2 yr-1)\n\n\nSpecies\nFlux.up\nFlux.down\nIntegral.Sum.R\n\n\n\n\nMn2\n-0.04996\n4e-05\n0.05\n\n\nMnO2\n0.05000\n0e+00\n-0.05\n\n\n\n\n\n\n\n\n\n\nDepth Integrated Reaction Rates\n\n\nCode\ndepth_integrated_reactionrates &lt;- function(std, grid) {\n  \n  integrated_reactionrate &lt;- function(rate, std, grid) {\n    \n    rate_integrated &lt;- sum(std$rates[[rate]] * grid$dx)\n    \n    return(rate_integrated)\n  }\n\n  rates &lt;- names(std$rates)\n  \n  result &lt;- data.frame(\n    \"Name\" = NULL,\n    \"Rate\" = NULL\n  )\n  \n  for (rate in rates) {\n  \n    result &lt;- rbind(\n      result,\n      data.frame(\n        \"Name\" = rate,\n        \"Rate\" = integrated_reactionrate(rate, std, grid)\n      )\n    )\n  }\n  \n  return(result)\n}\n\n\n\n\n\n\nstd1: depth integrated reaction rates (mol m-2 yr-1)\n\n\nName\nRate\n\n\n\n\nR1\n3.37873\n\n\nR2\n0.42816\n\n\nR3\n0.02500\n\n\nR4\n0.01868\n\n\nR5\n0.32968\n\n\nR9\n0.06333\n\n\nR6\n0.56475\n\n\nR7\n0.04977\n\n\nR8\n0.02277\n\n\nR10\n0.00034\n\n\nR11\n0.00009\n\n\nR12\n0.00663\n\n\nR13\n0.05551\n\n\nR14\n0.00000\n\n\n\n\n\n\nstd2: depth integrated reaction rates (mol m-2 yr-1)\n\n\nName\nRate\n\n\n\n\nR1\n3.37870\n\n\nR2\n0.42817\n\n\nR3\n0.02500\n\n\nR4\n0.01783\n\n\nR5\n0.32993\n\n\nR9\n0.06516\n\n\nR6\n0.56537\n\n\nR7\n0.02964\n\n\nR8\n0.01855\n\n\nR10\n0.00041\n\n\nR11\n0.00009\n\n\nR12\n0.00663\n\n\nR13\n0.05009\n\n\nR14\n0.00000"
  }
]